package com.koleshop.koleshopbackend.models.connection;

import com.google.appengine.api.utils.SystemProperty;
import com.koleshop.koleshopbackend.common.Constants;
import com.koleshop.koleshopbackend.servlets.GenericServlet;
import com.koleshop.koleshopbackend.utils.PropertiesCache;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.logging.Level;
import java.util.logging.Logger;


public class DatabaseConnection {

    private static final Logger logger = Logger.getLogger(DatabaseConnection.class.getName());

    public static Connection getConnection() {
        Connection connection = null;
        if (SystemProperty.environment.value() ==
                SystemProperty.Environment.Value.Production) {
            logger.log(Level.INFO, "will make connection using google app engine");
            connection = getGoogleAppEngineDBConnection();
        } else {
            logger.log(Level.INFO, "will make a regular connection (w/o using google app engine)");
            try {
                if (connection == null || connection.isClosed()) {
                    if(Constants.USE_LOCAL_DATABASE) {
                        connection = getLocalConnectionWithoutPool();
                    } else {
                        connection = getConnectionWithoutPool();
                    }
                }
            } catch (SQLException e) {
                logger.log(Level.INFO, "exception while making a regular connection", e);
            }
        }
        return connection;
    }

    private static Connection getConnectionWithoutPool() {
        Connection connection = null;

        String url = PropertiesCache.getInstance().getProperty("GOOGLE_CLOUD_SQL_URL");
        String username = PropertiesCache.getInstance().getProperty("GOOGLE_CLOUD_SQL_ALTERNATIVE_USERNAME");
        String password = PropertiesCache.getInstance().getProperty("GOOGLE_CLOUD_SQL_PASSWORD");
        try {
            Class.forName("com.mysql.jdbc.Driver");
        } catch (Exception e) {
            logger.log(Level.SEVERE, "exception while creating mysql driver", e);
            return null;
        }
        try {
            connection = DriverManager.getConnection(url, username, password);
            return connection;
        } catch (SQLException e) {
            logger.log(Level.SEVERE, "sql exception while creating mysql driver", e);
            return null;
        }
    }

    private static Connection getLocalConnectionWithoutPool() {
        Connection connection = null;

        String url = PropertiesCache.getInstance().getProperty("LOCAL_SQL_URL");
        String username = PropertiesCache.getInstance().getProperty("LOCAL_SQL_USERNAME");
        String password = PropertiesCache.getInstance().getProperty("LOCAL_SQL_PASSWORD");
        try {
            Class.forName("com.mysql.jdbc.Driver");
        } catch (Exception e) {
            logger.log(Level.SEVERE, "exception while creating mysql driver", e);
            return null;
        }
        try {
            connection = DriverManager.getConnection(url, username, password);
            return connection;
        } catch (SQLException e) {
            logger.log(Level.SEVERE, "sql exception while creating mysql driver", e);
            return null;
        }
    }

    private static Connection getConnectionFromPool() {

        Connection connection = null;
        try {
            connection = GenericServlet.getConnectionFromDBPool();
        } catch (SQLException e) {
            e.printStackTrace();
            return null;
        }

        if (connection != null) {
            return connection;
        } else {
            return null;
        }
    }

    public static Connection getGoogleAppEngineDBConnection() {
        Connection connection = null;
        String url = PropertiesCache.getInstance().getProperty("GOOGLE_APP_ENGINE_CLOUD_SQL_CONNECTION_STRING");
        String username = PropertiesCache.getInstance().getProperty("GOOGLE_CLOUD_SQL_USERNAME");
        String password = PropertiesCache.getInstance().getProperty("GOOGLE_CLOUD_SQL_PASSWORD");
        try {
            Class.forName("com.mysql.jdbc.GoogleDriver");
        } catch (Exception e) {
            logger.log(Level.SEVERE, "exception while creating google sql driver", e);
            return null;
        }
        try {
            connection = DriverManager.getConnection(url, username, password);
            return connection;
        } catch (SQLException e) {
            logger.log(Level.SEVERE, "exception while creating google sql driver", e);
            return null;
        }
    }
}
